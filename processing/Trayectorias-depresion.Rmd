--- 
title: "Trayectorias de sintomatología depresiva"
site: bookdown::bookdown_site
documentclass: book
link-citations: yes
linkcolor: blue
geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
author: Álvaro Jiménez, Fabián Duarte, Edgardo Cerda
description: "Trayectorias de sintomatología depresiva"
github-repo: "edgardo-cerda/trayectorias-salud-mental"
always_allow_html: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

# Cargar y preparar datos ELSOC {-}

<div style="text-align: justify">

## Cargar librerías

```{r, warning=FALSE, message=FALSE}
# Librerías básicas
library(tidyverse)
library(sjlabelled)

# Librerias análisis de secuencia
library(TraMineR)
library(TraMineRextras)
library(WeightedCluster)
library(cluster)

# Librería ELSOC
library(elsoc)

# Librerias graficos
library(ggpubr)
library(ggsankey)

# Libreria analisis estadístico
library(nnet)
library(modelsummary)
library(lcmm)

```


```{r}

# Cargar datos ELSOC:
elsoc::load_elsoc(data = 'wide')

# Crear variables de sintomatología depresiva por ola:
elsoc_salud <- elsoc_wide_2016_2021 %>% 
  
  # Se conservan observaciones presentes en las 5 olas
  filter(tipo_atricion == 1) %>% 
  
  # Crear variables de PHQ9
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9_w01 = (s11_01_w01 + s11_02_w01 + s11_03_w01 + s11_04_w01 + s11_05_w01 + s11_06_w01 + s11_07_w01 + s11_08_w01 + s11_09_w01),
         phq9_w02 = (s11_01_w02 + s11_02_w02 + s11_03_w02 + s11_04_w02 + s11_05_w02 + s11_06_w02 + s11_07_w02 + s11_08_w02 + s11_09_w02),
         phq9_w03 = (s11_01_w03 + s11_02_w03 + s11_03_w03 + s11_04_w03 + s11_05_w03 + s11_06_w03 + s11_07_w03 + s11_08_w03 + s11_09_w03),
         phq9_w04 = (s11_01_w04 + s11_02_w04 + s11_03_w04 + s11_04_w04 + s11_05_w04 + s11_06_w04 + s11_07_w04 + s11_08_w04 + s11_09_w04),
         phq9_w05 = (s11_01_w05 + s11_02_w05 + s11_03_w05 + s11_04_w05 + s11_05_w05 + s11_06_w05 + s11_07_w05 + s11_08_w05 + s11_09_w05)) %>% 
  
  # Quitar NAs
  filter(!is.na(phq9_w01), !is.na(phq9_w02), !is.na(phq9_w03), !is.na(phq9_w04), !is.na(phq9_w05)) %>% 
  
  # Crear indicador de depresión en 4 y en 2 categorías:
  mutate(depr4_w01 = car::recode(phq9_w01, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
         depr4_w02 = car::recode(phq9_w02, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
         depr4_w03 = car::recode(phq9_w03, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
         depr4_w04 = car::recode(phq9_w04, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
         depr4_w05 = car::recode(phq9_w05, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"),
         depr2_w01 = car::recode(phq9_w01, "0:9 = 0; 10:27 = 1"), 
         depr2_w02 = car::recode(phq9_w02, "0:9 = 0; 10:27 = 1"), 
         depr2_w03 = car::recode(phq9_w03, "0:9 = 0; 10:27 = 1"),  
         depr2_w04 = car::recode(phq9_w04, "0:9 = 0; 10:27 = 1"), 
         depr2_w05 = car::recode(phq9_w05, "0:9 = 0; 10:27 = 1"),
         phq_sum = phq9_w01 + phq9_w02 + phq9_w03 + phq9_w04 + phq9_w05
         )


# Cargar datos ELSOC LONG:
elsoc::load_elsoc(data = 'long')

# Crear variables de sintomatología depresiva por ola LONG:
elsoc_salud_long <- elsoc_long_2016_2021 %>% 
  
  # Se conservan observaciones presentes en las 5 olas
  filter(tipo_atricion == 1) %>% 
  
  # Crear variables de PHQ9
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>% 
  
  # Quitar NAs
  filter(!is.na(phq9)) %>% 
  
  # Crear indicador de depresión en 4 y en 2 categorías:
  mutate(depr4 = car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
         depr2 = car::recode(phq9, "0:9 = 0; 10:27 = 1"))


```

<!--chapter:end:index.Rmd-->


# Trayectorias de sintomatología depresiva. Modelo Optimal-Matching

## Secuencia de depresión con 4 categorías:

```{r}
# Crear objeto con secuencias
seq.depr4 <- TraMineR::seqdef(elsoc_salud, 
                             var = c('depr4_w01', 'depr4_w02', 'depr4_w03', 'depr4_w04', 'depr4_w05'), 
                             states = c('Sin síntomas', 'Síntomas medios', 'Síntomas moderados', 'Síntomas severos'), 
                             labels = c('Sin', 'Medios', 'Moderados', 'Severos'),
                             weights = elsoc_salud$ponderador02_w01,
                             cpal = c('lightgreen', 'mediumturquoise', 'skyblue3', 'slateblue4'))
```

### Gráfico de secuencias:

Muestra las secuencias/trayectorias que cubren el 95% de la muestra. Son 260 secuencias, ordenadas según frecuencia:

```{r}
TraMineR::seqfplot(seq.depr4, border = NA, with.legend = "top",
                   idxs = 1:260, space = 0)

```

### Frecuencia de estados y transiciones

```{r}
seqstatd(seq.depr4)

seqtrate(seq.depr4)

```


### Clusters de secuencias:

```{r}
# Medir distancias entre secuencias usando analisis de secuencias usando optimal matching analysis

# Se define matriz de costos de sustitución basados en valores medios de indice phq9
substitution_cost_matrix <- as.matrix(rbind(c(0, 5, 10, 19),
                                            c(5, 0, 5, 14),
                                            c(10, 5, 0, 9),
                                            c(19, 14, 9, 0)))

dist.depr4 <- TraMineR::seqdist(seq.depr4,
                               method = "OM",
                               sm = substitution_cost_matrix)
```


```{r}
# Construir tipos de trayectorias con analisis de cluster jerarquico Ward
ward.depr4 <- cluster::agnes(dist.depr4, diss = TRUE, method = 'ward')

# Comparar soluciones con diferentes numeros de trayectorias (se prueban de 2 a 10 clusters)
ward.range.depr4 <- WeightedCluster::as.clustrange(ward.depr4,
                                                  diss = dist.depr4, 
                                                  ncluster = 10)
# Visualizar clusters:
ward.range.depr4$stats %>% 
  mutate(clusters = 2:10) %>% 
  pivot_longer(cols = c(ASW, ASWw, HG, PBC, HC),
               names_to = 'indicador',
               values_to = 'value') %>%
  group_by(indicador) %>% 
  mutate(value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) %>% 
  ggplot(aes(y = value, x = clusters, color = indicador, group = indicador)) + 
  geom_line() + 
  scale_x_continuous(breaks = 2:10)

```


### Graficos de secuencias por clusters

Pruebas con 4, 5, 6 y 7 clusters

#### Agregar trayectorias a base de datos ELSOC:


```{r}
grafico_trayectorias4_K <- function(K, ward) {
  elsoc_trayectorias <- elsoc_salud
  elsoc_trayectorias$trayectoria <- stats::cutree(ward, k = K)
  
  
  nested_data <- elsoc_trayectorias %>% 
    group_by(trayectoria) %>% 
    nest()
  
  N <- purrr::map(.x = nested_data$data, .f = ~dim(.x)[1])
  graficos <- purrr::map2(.x = nested_data$data,
                          .y = N,
                          .f = ~ .x %>%
                            ggsankey::make_long(depr4_w01, depr4_w02, depr4_w03, depr4_w04, depr4_w05,
                                                value = 'ponderador02_w01') %>%
                            mutate(depr = factor(node,
                                                 levels = 1:4,
                                                 labels = c('Sin sintomas', 'medios', 'moderados', 'severos')),
                                   x = factor(x,
                                                 levels = glue::glue('depr4_w0{1:5}'),
                                                 labels = glue::glue('{c(2016:2019, 2021)}'))) %>%
                            ggplot(aes(x = x,
                                       next_x = next_x, 
                                       node = node, 
                                       next_node = next_node,
                                       fill = depr,
                                       value = value)) +
                            geom_sankey(flow.alpha = .6) +
                            labs(x = NULL,
                                 caption = glue::glue('N={.y}')) +
                            theme(legend.position = 'bottom',
                                  legend.title = element_blank()) +
                            scale_fill_viridis_d(direction = -1, end = .8,
                                                 drop = FALSE))
    
  
  plot <- ggpubr::ggarrange(plotlist = graficos,
                    common.legend = TRUE, legend = 'bottom')
  annotate_figure(plot, top = text_grob(glue::glue('{K} clusters')))
  
}
```


```{r}
purrr::map(.x = 4:7, ward = ward.depr4, .f = grafico_trayectorias4_K)
```

### Opción preferida: 5 clusters

Me gusta la opción con 5 clusters. Nombres provisorios:
 - Sintomas severos recurrentes
 - Remisión sintomas
 - Sintomas severos nuevos
 - Sintomas intermitentes
 - Sin sintomas/sintomas medios
 
```{r}

elsoc_salud$trayectoria_om4.5 <- stats::cutree(ward.depr4, k = 5)

```

```{r}

N <- table(elsoc_salud$trayectoria_om4.5)
nombres_cluster <- c('Sintomas severos recurrentes', 'Remisión sintomas', 'Síntomas severos nuevos',
              'Síntomas intermitentes', 'Sin sintomas/sintomas medios')

graficos <- purrr::map(.x = 1:5, .f = ~
                         elsoc_salud %>%
                         filter(trayectoria_om4.5 == .x) %>% 
  ggsankey::make_long(depr4_w01, depr4_w02, depr4_w03, depr4_w04, depr4_w05,
                      value = 'ponderador02_w01') %>%
  mutate(depr = factor(node,
                       levels = 1:4,
                       labels = c('Sin sintomas', 'medios', 'moderados', 'severos')),
         x = factor(x,
                    levels = glue::glue('depr4_w0{1:5}'),
                    labels = glue::glue('{c(2016:2019, 2021)}'))) %>%
  ggplot(aes(x = x,
             next_x = next_x, 
             node = node, 
             next_node = next_node,
             fill = depr,
             value = value)) +
  geom_sankey(flow.alpha = .6) +
  labs(x = NULL,
       caption = glue::glue('N={N[.x]}')) +
  theme(legend.position = 'bottom',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, end = .8)   +
  ggtitle(NULL, subtitle = glue::glue('{nombres_cluster[.x]}'))
)

plot <- ggpubr::ggarrange(plotlist = graficos,
                  common.legend = TRUE, legend = 'bottom')
annotate_figure(plot, top = text_grob(glue::glue('5 clusters')))
  
```


## Secuencia de depresión con 2 categorías


```{r}
# Crear objeto con secuencias
seq.depr2 <- TraMineR::seqdef(elsoc_salud, 
                             var = c('depr2_w01', 'depr2_w02', 'depr2_w03', 'depr2_w04', 'depr2_w05'), 
                             states = c('Sin síntomas/sintomas medios', 'sintomas moderados/severos'), 
                             labels = c('Sin/medios', 'Moderados/Severos'),
                             weights = elsoc_salud$ponderador02_w01,
                             cpal = c('lightgreen', 'slateblue4'))
```

### Gráfico de secuencias:

Hay 32 secuencias en total

```{r}
TraMineR::seqfplot(seq.depr2, border = NA, with.legend = "top",
                   idxs = 1:32, space = 0)

```

### Clusters de secuencias:

```{r}

dist.depr2 <- TraMineR::seqdist(seq.depr2, method = "OM", sm = 'CONSTANT')

# Construir tipos de trayectorias con analisis de cluster jerarquico Ward
ward.depr2 <- cluster::agnes(dist.depr2, diss = TRUE, method = 'ward')

# Comparar soluciones con diferentes numeros de trayectorias (se prueban de 2 a 10 clusters)
ward.range.depr2 <- WeightedCluster::as.clustrange(ward.depr2,
                                                  diss = dist.depr2, 
                                                  ncluster = 10)

# Visualizar clusters:
ward.range.depr2$stats %>% 
  mutate(clusters = 2:10) %>% 
  pivot_longer(cols = c(ASW, ASWw, HG, PBC, HC),
               names_to = 'indicador',
               values_to = 'value') %>%
  group_by(indicador) %>% 
  mutate(value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) %>% 
  ggplot(aes(y = value, x = clusters, color = indicador, group = indicador)) + 
  geom_line() + 
  scale_x_continuous(breaks = 2:10)

```

### Gráficos de secuencia por clusters

```{r}

grafico_trayectorias2_K <- function(K, ward) {
  elsoc_trayectorias <- elsoc_salud
  elsoc_trayectorias$trayectoria <- stats::cutree(ward, k = K)
  
  
  nested_data <- elsoc_trayectorias %>% 
    group_by(trayectoria) %>% 
    nest()
  
  N <- purrr::map(.x = nested_data$data, .f = ~dim(.x)[1])
  graficos <- purrr::map2(.x = nested_data$data,
                          .y = N,
                          .f = ~ .x %>%
                            ggsankey::make_long(depr2_w01, depr2_w02, depr2_w03, depr2_w04, depr2_w05,
                                                value = 'ponderador02_w01') %>%
                            mutate(depr = factor(node,
                                                 levels = 0:1,
                                                 labels = c('Sin sintomas/medios', 'Síntomas moderados/severos')),
                                   x = factor(x,
                                                 levels = glue::glue('depr2_w0{1:5}'),
                                                 labels = glue::glue('{c(2016:2019, 2021)}'))) %>%
                            ggplot(aes(x = x,
                                       next_x = next_x, 
                                       node = node, 
                                       next_node = next_node,
                                       fill = depr,
                                       value = value)) +
                            geom_sankey(flow.alpha = .6) +
                            labs(x = NULL,
                                 caption = glue::glue('N={.y}')) +
                            theme(legend.position = 'bottom',
                                  legend.title = element_blank()) +
                            scale_fill_viridis_d(direction = -1, end = .8,
                                                 drop = FALSE))
    
  
  plot <- ggpubr::ggarrange(plotlist = graficos,
                    common.legend = TRUE, legend = 'bottom')
  annotate_figure(plot, top = text_grob(glue::glue('{K} clusters')))
  
}
```

```{r}
purrr::map(.x = 2:7, ward = ward.depr2, .f = grafico_trayectorias2_K)
```

```{r}
elsoc_salud$trayectoria_om2.3 <- stats::cutree(ward.depr2, k = 3)

```


<!--chapter:end:01-modelo-optimal-matching.Rmd-->

# Trayectorias de sintomatologia depresiva. Modelo GMM

```{r}
set.seed(123)

```

## Identificar trayectorias:

### Modelos de trayectorias lineales: {-}

Se usa el modelo de 1 clase para fijar los valores iniciales a iterar:

```{r, results=FALSE}
lcga1_lin <- hlme(phq9 ~ ola, subject = "idencuesta", ng = 1, 
              data = elsoc_salud_long)

lcga2_lin <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_lin, 
                    hlme(phq9 ~ ola , subject = "idencuesta", ng = 2, 
                         data = elsoc_salud_long, mixture = ~ ola))

lcga3_lin <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_lin, 
                    hlme(phq9 ~ ola, subject = "idencuesta", ng = 3, 
                         data = elsoc_salud_long, mixture = ~ ola))

lcga4_lin <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_lin, 
                    hlme(phq9 ~ ola, subject = "idencuesta", ng = 4, 
                         data = elsoc_salud_long, mixture = ~ ola))

lcga5_lin <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_lin, 
                    hlme(phq9 ~ ola, subject = "idencuesta", ng = 5, 
                         data = elsoc_salud_long, mixture = ~ ola))
```

### Modelos de trayectorias cuadráticas: {-}

```{r, results=FALSE}

lcga1_quad <- hlme(phq9 ~ ola + I(ola^2), subject = "idencuesta", ng = 1, 
              data = elsoc_salud_long)

lcga2_quad <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_quad, 
                    hlme(phq9 ~ ola + I(ola^2), subject = "idencuesta", ng = 2, 
                         data = elsoc_salud_long, mixture = ~ ola + I(ola^2)))

lcga3_quad <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_quad, 
                    hlme(phq9 ~ ola + I(ola^2), subject = "idencuesta", ng = 3, 
                         data = elsoc_salud_long, mixture = ~ ola + I(ola^2)))

lcga4_quad <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_quad, 
                    hlme(phq9 ~ ola + I(ola^2), subject = "idencuesta", ng = 4, 
                         data = elsoc_salud_long, mixture = ~ ola + I(ola^2)))

lcga5_quad <- gridsearch(rep = 10, maxiter = 10, minit = lcga1_quad, 
                    hlme(phq9 ~ ola + I(ola^2), subject = "idencuesta", ng = 5, 
                         data = elsoc_salud_long, mixture = ~ ola + I(ola^2)))

```

### Comparación resultados {-}

```{r, results=FALSE}
# Comparar resultados:
resultados_comparados <- summarytable(lcga1_lin, lcga1_quad, 
                             lcga2_lin, lcga2_quad, 
                             lcga3_lin, lcga3_lin,
                             lcga4_lin, lcga4_quad, 
                             lcga5_lin, lcga5_quad)
```


```{r}
kableExtra::kbl(resultados_comparados,
                digits = 1)

```

## Principales trayectorias

Según criterios de información debería estar entre 4y 5 clases:


```{r}
summary(lcga4_lin)

pred_lcga4_lin <- predictY(lcga4_lin, data.frame(ola = 1:5))

plot(pred_lcga4_lin, ylim = c(0, 27))

```


```{r}
summary(lcga4_quad)

pred_lcga4_quad <- predictY(lcga4_quad, data.frame(ola = 1:5))

plot(pred_lcga4_quad, ylim = c(0, 27))

```


```{r}
summary(lcga5_lin)

pred_lcga5_lin <- predictY(lcga5_lin, data.frame(ola = 1:5))

plot(pred_lcga5_lin, ylim = c(0, 27))

```


```{r}
summary(lcga5_quad)

pred_lcga5_quad <- predictY(lcga5_quad, data.frame(ola = 1:5))

plot(pred_lcga5_quad, ylim = c(0, 27))

```

```{r}

elsoc_salud$trayectoria_gmm.3lin <- elsoc_salud %>% 
  left_join(lcga3_lin$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class)

elsoc_salud$trayectoria_gmm.3quad <- elsoc_salud %>% 
  left_join(lcga3_quad$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class)

elsoc_salud$trayectoria_gmm.4lin <- elsoc_salud %>% 
  left_join(lcga4_lin$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class)

elsoc_salud$trayectoria_gmm.4quad <- elsoc_salud %>% 
  left_join(lcga4_quad$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class)


```


<!--chapter:end:02-modelo-gmm.Rmd-->


# Creacion Variables independientes


```{r}
elsoc_salud_5_modelo <- elsoc_salud_5 %>% 
    filter(!elsoc::is_nsnr(m30_w01, m30_w02, m30_w03, m30_w04, m30b_w05)) %>% 
  mutate(
    m30_w01 = 1000*as.numeric(car::recode(m30_w01, "1 = 220; 2 = 250; 3 = 305; 4 = 355; 5 = 400; 6 = 445; 7 = 490; 
                                      8 = 535; 9 = 585; 10 = 640; 11 = 700; 12 = 765; 13 = 845; 14 = 935;
                                      15 = 1040; 16 = 1180; 17 = 1375; 18 = 1670; 19 = 2275; 20 = 2700; NA = NA")),
    m29_w01_imp = ifelse(is_nsnr(m29_w01), m30_w01, m29_w01),
    ypc_w01 = m29_w01_imp / nhogar1_w01) %>%  
  mutate(quintil_w01 = statar::xtile(ypc_w01, n = 5, wt = ponderador02_w01),
         # quintil_w01 = factor(quintil_w01,
         #                      levels = 1:5,
         #                      labels = glue::glue('Quintil {1:5}')),
         trayectoria = factor(trayectoria,
                              levels = 1:5,
                              labels = c('Sintomas severos recurrentes',
                                         'Remisión sintomas',
                                         'Sintomas severos nuevos',
                                         'Sintomas intermitentes',
                                         'Sin sintomas/sintomas medios')),
         trayectoria = fct_rev(trayectoria),
         sexo = factor(m0_sexo_w01, levels = 1:2,
                       labels = c('Hombre', 'Mujer')))
```

## Modelo multinomial logit

```{r}


m1 <- elsoc_salud_5_modelo %>%
  multinom(trayectoria ~ sexo + m0_edad_w01 + quintil_w01,
           data = .) 


modelsummary(m1,
             stars = c('*' = .05, '**' = .01, '***' = .001),
             group = model + term ~ y.level)

```

<!--chapter:end:03-variables-independientes.Rmd-->

