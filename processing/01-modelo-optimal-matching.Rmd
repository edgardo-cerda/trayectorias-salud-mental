
# Trayectorias de sintomatología depresiva. Modelo Optimal-Matching

## Secuencia de depresión con 4 categorías:

```{r}
# Crear objeto con secuencias
seq.depr4 <- TraMineR::seqdef(elsoc_salud, 
                             var = c('depr4_w01', 'depr4_w02', 'depr4_w03', 'depr4_w04', 'depr4_w05'), 
                             states = c('Sin síntomas', 'Síntomas medios', 'Síntomas moderados', 'Síntomas severos'), 
                             labels = c('Sin', 'Medios', 'Moderados', 'Severos'),
                             weights = elsoc_salud$ponderador02_w01,
                             cpal = c('lightgreen', 'mediumturquoise', 'skyblue3', 'slateblue4'))
```

### Gráfico de secuencias:

Muestra las secuencias/trayectorias que cubren el 95% de la muestra. Son 260 secuencias, ordenadas según frecuencia:

```{r}
TraMineR::seqfplot(seq.depr4, border = NA, with.legend = "top",
                   idxs = 1:260, space = 0)

```

### Frecuencia de estados y transiciones

```{r}
seqstatd(seq.depr4)

seqtrate(seq.depr4)

```


### Clusters de secuencias:

```{r}
# Medir distancias entre secuencias usando analisis de secuencias usando optimal matching analysis

# Se define matriz de costos de sustitución basados en valores medios de indice phq9
substitution_cost_matrix <- as.matrix(rbind(c(0, 5, 10, 19),
                                            c(5, 0, 5, 14),
                                            c(10, 5, 0, 9),
                                            c(19, 14, 9, 0)))

dist.depr4 <- TraMineR::seqdist(seq.depr4,
                               method = "OM",
                               sm = substitution_cost_matrix)
```


```{r}
# Construir tipos de trayectorias con analisis de cluster jerarquico Ward
ward.depr4 <- cluster::agnes(dist.depr4, diss = TRUE, method = 'ward')

# Comparar soluciones con diferentes numeros de trayectorias (se prueban de 2 a 10 clusters)
ward.range.depr4 <- WeightedCluster::as.clustrange(ward.depr4,
                                                  diss = dist.depr4, 
                                                  ncluster = 10)
# Visualizar clusters:
ward.range.depr4$stats %>% 
  mutate(clusters = 2:10) %>% 
  pivot_longer(cols = c(ASW, ASWw, HG, PBC, HC),
               names_to = 'indicador',
               values_to = 'value') %>%
  group_by(indicador) %>% 
  mutate(value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) %>% 
  ggplot(aes(y = value, x = clusters, color = indicador, group = indicador)) + 
  geom_line() + 
  scale_x_continuous(breaks = 2:10)

```


### Graficos de secuencias por clusters

Pruebas con 4, 5, 6 y 7 clusters

#### Agregar trayectorias a base de datos ELSOC:


```{r}
grafico_trayectorias4_K <- function(K, ward) {
  elsoc_trayectorias <- elsoc_salud
  elsoc_trayectorias$trayectoria <- stats::cutree(ward, k = K)
  
  
  nested_data <- elsoc_trayectorias %>% 
    group_by(trayectoria) %>% 
    nest()
  
  N <- purrr::map(.x = nested_data$data, .f = ~dim(.x)[1])
  graficos <- purrr::map2(.x = nested_data$data,
                          .y = N,
                          .f = ~ .x %>%
                            ggsankey::make_long(depr4_w01, depr4_w02, depr4_w03, depr4_w04, depr4_w05,
                                                value = 'ponderador02_w01') %>%
                            mutate(depr = factor(node,
                                                 levels = 1:4,
                                                 labels = c('Sin sintomas', 'medios', 'moderados', 'severos')),
                                   x = factor(x,
                                                 levels = glue::glue('depr4_w0{1:5}'),
                                                 labels = glue::glue('{c(2016:2019, 2021)}'))) %>%
                            ggplot(aes(x = x,
                                       next_x = next_x, 
                                       node = node, 
                                       next_node = next_node,
                                       fill = depr,
                                       value = value)) +
                            geom_sankey(flow.alpha = .6) +
                            labs(x = NULL,
                                 caption = glue::glue('N={.y}')) +
                            theme(legend.position = 'bottom',
                                  legend.title = element_blank()) +
                            scale_fill_viridis_d(direction = -1, end = .8,
                                                 drop = FALSE))
    
  
  plot <- ggpubr::ggarrange(plotlist = graficos,
                    common.legend = TRUE, legend = 'bottom')
  annotate_figure(plot, top = text_grob(glue::glue('{K} clusters')))
  
}
```


```{r}
purrr::map(.x = 4:7, ward = ward.depr4, .f = grafico_trayectorias4_K)
```

### Opción preferida: 4 clusters

Me gusta la opción con 4 clusters. Nombres provisorios:
 - Trayectoria alta/moderada
 - Trayectoria descendente
 - Trayectoria ascendente
 - Trayectoria media/moderada
 - Trayectoria baja/media
 

```{r}

N <- table(stats::cutree(ward.depr4, k = 5))
nombres_cluster <- c('Trayectoria alta/moderada', 
                     'Trayectoria descendente', 
                     'Trayectoria ascendente', 
                     'Trayectoria media/moderada', 
                     'Trayectoria baja/media')

graficos <- purrr::map(.x = 1:5, .f = ~
                         elsoc_salud %>%
                         mutate(trayectoria = stats::cutree(ward.depr4, k = 5)) %>% 
                         filter(trayectoria == .x) %>% 
  ggsankey::make_long(depr4_w01, depr4_w02, depr4_w03, depr4_w04, depr4_w05,
                      value = 'ponderador02_w01') %>%
  mutate(depr = factor(node,
                       levels = 1:4,
                       labels = c('Sin sintomas', 'medios', 'moderados', 'severos')),
         x = factor(x,
                    levels = glue::glue('depr4_w0{1:5}'),
                    labels = glue::glue('{c(2016:2019, 2021)}'))) %>%
  ggplot(aes(x = x,
             next_x = next_x, 
             node = node, 
             next_node = next_node,
             fill = depr,
             value = value)) +
  geom_sankey(flow.alpha = .6) +
  labs(x = NULL,
       caption = glue::glue('N={N[.x]}')) +
  theme(legend.position = 'bottom',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, end = .8, drop = FALSE)   +
  ggtitle(NULL, subtitle = glue::glue('{nombres_cluster[.x]}'))
)

plot <- ggpubr::ggarrange(plotlist = graficos,
                  common.legend = TRUE, legend = 'bottom')
annotate_figure(plot, top = text_grob(glue::glue('5 clusters')))
  
```


## Secuencia de depresión con 2 categorías


```{r}
# Crear objeto con secuencias
seq.depr2 <- TraMineR::seqdef(elsoc_salud, 
                             var = c('depr2_w01', 'depr2_w02', 'depr2_w03', 'depr2_w04', 'depr2_w05'), 
                             states = c('Sin síntomas/sintomas medios', 'sintomas moderados/severos'), 
                             labels = c('Sin/medios', 'Moderados/Severos'),
                             weights = elsoc_salud$ponderador02_w01,
                             cpal = c('lightgreen', 'slateblue4'))
```

### Gráfico de secuencias:

Hay 32 secuencias en total

```{r}
TraMineR::seqfplot(seq.depr2, border = NA, with.legend = "top",
                   idxs = 1:32, space = 0)

```

### Clusters de secuencias:

```{r}

dist.depr2 <- TraMineR::seqdist(seq.depr2, method = "OM", sm = 'CONSTANT')

# Construir tipos de trayectorias con analisis de cluster jerarquico Ward
ward.depr2 <- cluster::agnes(dist.depr2, diss = TRUE, method = 'ward')

# Comparar soluciones con diferentes numeros de trayectorias (se prueban de 2 a 10 clusters)
ward.range.depr2 <- WeightedCluster::as.clustrange(ward.depr2,
                                                  diss = dist.depr2, 
                                                  ncluster = 10)

# Visualizar clusters:
ward.range.depr2$stats %>% 
  mutate(clusters = 2:10) %>% 
  pivot_longer(cols = c(ASW, ASWw, HG, PBC, HC),
               names_to = 'indicador',
               values_to = 'value') %>%
  group_by(indicador) %>% 
  mutate(value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) %>% 
  ggplot(aes(y = value, x = clusters, color = indicador, group = indicador)) + 
  geom_line() + 
  scale_x_continuous(breaks = 2:10)

```

### Gráficos de secuencia por clusters

```{r}

grafico_trayectorias2_K <- function(K, ward) {
  elsoc_trayectorias <- elsoc_salud
  elsoc_trayectorias$trayectoria <- stats::cutree(ward, k = K)
  
  
  nested_data <- elsoc_trayectorias %>% 
    group_by(trayectoria) %>% 
    nest()
  
  N <- purrr::map(.x = nested_data$data, .f = ~dim(.x)[1])
  graficos <- purrr::map2(.x = nested_data$data,
                          .y = N,
                          .f = ~ .x %>%
                            ggsankey::make_long(depr2_w01, depr2_w02, depr2_w03, depr2_w04, depr2_w05,
                                                value = 'ponderador02_w01') %>%
                            mutate(depr = factor(node,
                                                 levels = 0:1,
                                                 labels = c('Sin sintomas/medios', 'Síntomas moderados/severos')),
                                   x = factor(x,
                                                 levels = glue::glue('depr2_w0{1:5}'),
                                                 labels = glue::glue('{c(2016:2019, 2021)}'))) %>%
                            ggplot(aes(x = x,
                                       next_x = next_x, 
                                       node = node, 
                                       next_node = next_node,
                                       fill = depr,
                                       value = value)) +
                            geom_sankey(flow.alpha = .6) +
                            labs(x = NULL,
                                 caption = glue::glue('N={.y}')) +
                            theme(legend.position = 'bottom',
                                  legend.title = element_blank()) +
                            scale_fill_viridis_d(direction = -1, end = .8,
                                                 drop = FALSE))
    
  
  plot <- ggpubr::ggarrange(plotlist = graficos,
                    common.legend = TRUE, legend = 'bottom')
  annotate_figure(plot, top = text_grob(glue::glue('{K} clusters')))
  
}
```

```{r}
purrr::map(.x = 2:7, ward = ward.depr2, .f = grafico_trayectorias2_K)
```
