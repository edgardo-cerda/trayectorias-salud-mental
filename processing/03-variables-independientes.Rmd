
# Modelos


## Preparar datos:

### Agregar variables de trayectoria de los distintos modelos: {-}

```{r}
elsoc_salud$trayectoria_om4.5 <- factor(stats::cutree(ward.depr4, k = 5),
                                        levels = c(5, 4, 2, 3, 1),
                              labels = c('Trayectoria baja/media',
                                         'Trayectoria media/moderada',
                                         'Trayectoria descendente',
                                         'Trayectoria ascendente',
                                         'Trayectoria alta/moderada'))

elsoc_salud$trayectoria_om2.3 <- stats::cutree(ward.depr2, k = 3)


elsoc_salud$trayectoria_gmm.4lin <- factor(elsoc_salud %>% 
  left_join(lcga4_lin$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class),
  levels = c(4, 3, 1, 2),
  labels = c('Trayectoria baja', 'Trayectoria media', 'Trayectoria descendente', 'Trayectoria ascendente'))

elsoc_salud$trayectoria_gmm.4quad <- factor(elsoc_salud %>% 
  left_join(lcga4_quad$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class),
  levels = c(3, 2, 1, 4),
    labels = c('Trayectoria baja', 'Trayectoria media', 'Trayectoria descendente', 'Trayectoria ascendente'))

elsoc_salud$trayectoria_gmm.5lin <- elsoc_salud %>% 
  left_join(lcga5_lin$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class)

elsoc_salud$trayectoria_gmm.5quad <- elsoc_salud %>% 
  left_join(lcga5_quad$pprob %>% select(idencuesta, class),
            by = 'idencuesta') %>%
  pull(class)

```

### Agregar variables independientes {-}

```{r}

elsoc_salud_modelo <- elsoc_salud %>% 
    filter(!elsoc::is_nsnr(m30_w01, m30_w02, m30_w03, m30_w04, m30b_w05)) %>% 
  mutate(
    
    m30_w01 = 1000*as.numeric(car::recode(m30_w01, "1 = 220; 2 = 250; 3 = 305; 4 = 355; 5 = 400; 6 = 445; 7 = 490; 
                                      8 = 535; 9 = 585; 10 = 640; 11 = 700; 12 = 765; 13 = 845; 14 = 935;
                                      15 = 1040; 16 = 1180; 17 = 1375; 18 = 1670; 19 = 2275; 20 = 2700; NA = NA")),
    m29_w01_imp = ifelse(is_nsnr(m29_w01), m30_w01, m29_w01),
    ypc_w01 = m29_w01_imp / nhogar1_w01,
    
    m30_w02 = 1000*as.numeric(car::recode(m30_w02, "1 = 220; 2 = 250; 3 = 305; 4 = 355; 5 = 400; 6 = 445; 7 = 490; 
                                      8 = 535; 9 = 585; 10 = 640; 11 = 700; 12 = 765; 13 = 845; 14 = 935;
                                      15 = 1040; 16 = 1180; 17 = 1375; 18 = 1670; 19 = 2275; 20 = 2700; NA = NA")),
    m29_w02_imp = ifelse(is_nsnr(m29_w02), m30_w02, m29_w02),
    ypc_w02 = m29_w02_imp / nhogar1_w01,    
    
    m30_w03 = 1000*as.numeric(car::recode(m30_w03, "1 = 220; 2 = 250; 3 = 305; 4 = 355; 5 = 400; 6 = 445; 7 = 490; 
                                      8 = 535; 9 = 585; 10 = 640; 11 = 700; 12 = 765; 13 = 845; 14 = 935;
                                      15 = 1040; 16 = 1180; 17 = 1375; 18 = 1670; 19 = 2275; 20 = 2700; NA = NA")),
    m29_w03_imp = ifelse(is_nsnr(m29_w03), m30_w03, m29_w03),
    ypc_w03 = m29_w03_imp / ifelse(is_nsnr(m54_w03), NA, m54_w03),
    
    m30_w04 = 1000*as.numeric(car::recode(m30_w04, "1 = 220; 2 = 250; 3 = 305; 4 = 355; 5 = 400; 6 = 445; 7 = 490; 
                                      8 = 535; 9 = 585; 10 = 640; 11 = 700; 12 = 765; 13 = 845; 14 = 935;
                                      15 = 1040; 16 = 1180; 17 = 1375; 18 = 1670; 19 = 2275; 20 = 2700; NA = NA")),
    m29_w04_imp = ifelse(is_nsnr(m29_w04), m30_w04, m29_w04),
    ypc_w04 = m29_w04_imp / ifelse(is_nsnr(m54_w04), NA, m54_w04),
    
    m30b_w05 = 1000*as.numeric(car::recode(m30b_w05, "1 = 225; 2 = 575; 3 = 850; 4 = 1250; 5 = 1750; NA = NA")),
    m29_w05_imp = ifelse(is_nsnr(m29_w05), m30b_w05, m29_w05),
    ypc_w05 = m29_w05_imp / ifelse(is_nsnr(m54_w05), NA, m54_w05),
    
    quintil_w01 = statar::xtile(ypc_w01, n = 5, wt = ponderador02_w01),
    quintil_w01 = factor(quintil_w01,
                         levels = 1:5,
                         labels = glue::glue('Quintil {1:5}')),
    quintil_w02 = statar::xtile(ypc_w02, n = 5, wt = ponderador02_w02),
    quintil_w02 = factor(quintil_w02,
                         levels = 1:5,
                         labels = glue::glue('Quintil {1:5}')),
    quintil_w03 = statar::xtile(ypc_w03, n = 5, wt = ponderador02_w03),
    quintil_w03 = factor(quintil_w03,
                         levels = 1:5,
                         labels = glue::glue('Quintil {1:5}')),
    quintil_w04 = statar::xtile(ypc_w04, n = 5, wt = ponderador02_w04),
    quintil_w04 = factor(quintil_w04,
                         levels = 1:5,
                         labels = glue::glue('Quintil {1:5}')),
    quintil_w05 = statar::xtile(ypc_w05, n = 5, wt = ponderador02_w05),
    quintil_w05 = factor(quintil_w05,
                         levels = 1:5,
                         labels = glue::glue('Quintil {1:5}')),
   
    ocup_w01 = factor(car::recode(m02_w01, "1:3 = 1; 6 = 2; 4:5 = 3; 7:9 = 3"),
                      levels = 1:3,
                      labels = c('Ocupado', 'Desempleado', 'Inactivo')),
    sexo = factor(m0_sexo_w01, levels = 1:2,
                  labels = c('Hombre', 'Mujer')))


```


## Modelo multinomial logit

```{r}


m1 <- elsoc_salud_modelo %>%
  multinom(trayectoria_om4.5 ~ sexo + m0_edad_w01 + quintil_w01 + factor(m43_w01 == 5) + ocup_w01,
           data = .) 

m2 <- elsoc_salud_modelo %>%
  multinom(trayectoria_gmm.4lin ~ sexo + m0_edad_w01 + quintil_w01 + factor(m43_w01 == 5) + ocup_w01,
           data = .) 

modelsummary(m1,
             stars = c('*' = .05, '**' = .01, '***' = .001),
             group = model + term ~ y.level)

modelsummary(m2,
             stars = c('*' = .05, '**' = .01, '***' = .001),
             group = model + term ~ y.level)

```
